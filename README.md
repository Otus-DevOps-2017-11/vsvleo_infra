## vsvleo_infra
### Домашнее задание 05
#### Сквозное пдключение к инстансу internalhost, в одну строку:
```ssh -i ~/.ssh/appuser -A appuser@104.155.51.79 -t ssh 10.154.0.2 # connect in the one line```
#### Для создания алиаса, в каталоге пользователя редактируем файл: ~/.ssh/config
1. вариант _(с созданием дополнительного алиаса, для доступа на сервер bastion)_ :
```
Host bastion
    User appuser
    HostName 104.155.51.79

Host internalhost
    User appuser
    HostName 10.154.0.2
    IdentityFile ~/.ssh/appuser
    ProxyCommand ssh -W %h:%p bastion
 ```

2. вариант _(с помощью одного алиаса)_
```
Host internalhost
    User appuser
    HostName 10.154.0.2
    IdentityFile ~/.ssh/appuser
    ProxyCommand ssh -W %h:%p appuser@104.155.51.79
```
#### Создание VPN канала (OpenVPN)

**Инстанс bastion**
10.132.0.2 - Внутренний IP адрес
104.155.51.79 - внешний IP адрес
**Инстанс someinternalhost**
10.154.0.2 - внутренний IP адрес

Файлы:
```
krista\_test\_vpn-10855.ovpn - Файл конфигураций для создания клиента
setupvpn.sh - Скрипт для установки OpenVPN на GCP инстанс.
```

---

### Домашнее задание 06
#### Скрипт установки **ruby**
01. install_ruby.sh 
#### Скрипт установки **mongodb**
02. install_mongodb.sh
#### Скрипт скачивания и деплоя приложения
03. deploy.sh

### Некоторые команды работы с packer
```
packer validate ubuntu16.json - проверка шаблона
packer build ubuntu16.json - запуск процесса сборки образа
```

---

### Домашнее задание 07
#### Шаблон для создания образа средствами packer
ubuntu16.json - шаблон с включенным переопределением переменных:
```
  "variables": {
    "proj_id": null,
    "family_image": null,
    "type_machines": "f1-micro"
  },
```
proj_id - переменная определяет ID проекта, по умолчанию не определена<br/>
family_image - семейство образов, так же не определена по умолчанию<br/>
type_machines - тип инстанса, здесь установлено значение по умолчанию: "f1-micro"<br/>

Запуск оссуществляется с обязательным указанием переменных proj-id и family_image
```
packer build -var "family_image=[имя семейства образов]" -var "proj_id=[ID проекта]" ubuntu16.json
```
При вынесении определения переменных в отдельный файл variables.json (в качестве примера указан файл variables.json.example), в параметрах запуска необходимо, по мимо самих переменных 
proj-id и family_image, так же указать и сам файл:
```
packer validate -var-file=variables.json -var "family_image=[имя семейства образов]" -var "proj_id=[ID проекта]" ubuntu16.json
```

---

### Домашнее задание 08
#### Создание инстанса при использовании terraform
Команды которые применялись при выполнении домашнего задания:
```
terraform init - загружает провайдер, указанный в файле main.tf
terraform plan - отображает планируемые изменения
terraform apply - Запускает инстанс или применяет изменения
        -auto-approve=true - вкючает автоматическое подтверждение запросов при выполнении
terrafom show - выводит все атрибуты из state файла.
terraform refresh - переопределение переменных с атрибутов state файла
terraform output - выводит список переменных и их значений или только значение указанной переменной
terraform taint [имя ресурса] - при применении изменений указанный ресурс будет пересоздан
terraform destroy - удаляет все ресурсы
terraform fmt - форматирование конфигурационных файлов
```
Описание созданных файлов:
```
main.tf - основной конфигурационный файл
output.tf - файл с описанием выходных переменных
variables.tf - файл с описанием входных переменных
terraform.tfvars - определение значений для переменных. в репозитории выложен пример файла terraform.tfvars.example
/files/deploy.sh - скрипт для установки и запуска приложения reddit
/files/puma.service - конфигурационный файл для инициализации приложения reddit
```
Для создания инстанса необходимо задать значения переменных в файле terraform.tfvars, в качестве примера 
можно посмотреть файл terraform.tfvars.exampe. Для понимания, какие переменные имеют дефолтные значения, 
но могут быть переопределены, можно посмотреть в файле variables.tf, значение default.<br/>
Следующим шагом будет инициализация провайдера коммандой terraform init и далее, непосредственно сам 
запуск инстанса terraform apply<br/>
Для выполнения вышеописанных команд должен быть скачен сам terraform https://www.terraform.io/downloads.html. 
Прописан путь до файла terraform. И все команды выполнять в папке с файлом main.tf

---

### Домашнее задание 09
#### Дополнительные команды для terraform
```
terraform import [имя ресурса в main.tf] [название ресурса в GCP] - добавляется информация о текущем
    состоянии, в state файл.
terraform get - Загружает модули. В служебной папке .terraform загружаются модули с репозитория или 
    создаются символические ссылки на локальные модули, указанные в основном файле main.tf.
```
#### Создание дополнительных образов VM
на основе файла ubuntu16.04 были созданы два файла app.json и db.json. Файлы расположены в<br/>
папке packer/ , для создания образов применялись следующие команды:
```
packer build -var "family_image=reddit-app-base" -var "proj_id=infra-XXXXXX" app.json
packer build -var "family_image=reddit-db-base" -var "proj_id=infra-XXXXXX" db.json
```
#### Разбивка конфига main.tf на несколько конфигов
В результате выненесения конфигураций в два разных файла, получил отдельный запуск инстансов <br/>
apt.tf - запускает VM из образа reddit-app-base,<br/>
db.tf - запускает VM из образа reddit-db-base.<br/>
Тем самым для каждого инстанса могут быть выбраны персональные настройки.<br/>
Так же был создан отдельный конфигурационный файл vpc.tf, для настроек фаевола, который подходит 
для обоих образов.<br/>
#### Разбивка созданных конфигов на модули
Под каждый конфигурационный файл, котовые создал ранее (app.tf, db.tf, vpc.tf), были созданы 
соответствующие папки в каталоге modules.<br/>
В папки я перенес конфигурационные файлы, переименовав в main.tf, добавил конфиг с определением
переменных, которые используются только для данного модуля. И в каталог app добавил файл outputs.tf,
для определения IP адреса.<br/>
В основном файле main.tf добавил настройки для каждого модуля, с указанием пути до каждого.<br/>
Выполнил загрузку модулей командой ```terraform get```
Доступ по SHH к обоим инстансам выполняется командой:
``` 
ssh -i ~/.ssh/appuser appuser@xxx.xxx.xxx.xxx 
```
Для ограничения доступа только с определеннх диапазона IP адресов, можно указать данный диапазон 
в main.tf. переменная source_ranges. По умолчанию разрешен весь диапазон IP адресов ["0.0.0.0/0"].<br/>
Если IP адрес, с которого планируется зайти на VM, не попадает в указанный диапазон, то в доступе 
будет отказано.<br/>
#### Переиспользование кода
Было создано два варианта создания инстансов prod и stage. Для варианта prod добавил дополнительный
параметр source_ranges_puma - Указывает диапазон допустимых IP адресов для доступа в веб интерфейсу.
#### Использование внешних модулей
Выдавало ошибку на параметр name = [storage-bucket-test... <br/>
Изменил на storage-bucket-vlasenko

---

### Домашнее задание 10
#### Установка ansible
Для установки ansible, предварительно потребовалость установить pip
```
sudo apt install python-pip
pip install --upgrade pip

```
Установка самого ansible
```
pip install ansible>=2.4
ansible --version
```
#### Используемые файлы
ansible.cfg - основной конфигурационный файл ansible. Указывается путь до рабочего каталога, а так же описываются
параметры доступа на инстанс, с помощью inventory файла.<br/>
invertory - файл с описанием хостов. Может хранить подробную информацию для доступа на хост, может хранить только 
адреса хостов, если даные для доступа указаны в ansible.cfg<br/>
invertory.yml - вариант, аналогичный inventory файлу, только написан на yaml
#### Файл inventory
Однострочные настройки для каждого хоста, например:
```
appserver ansible_host=35.195.186.154 ansible_user=appuser ansible_private_key_file=~/.ssh/ appuser
```
#### Некоторые примеры запуска ansible
Проверка подключения к хосту с идентификатором appserver, определенном в invertory файле, выполняется пинг хоста
```
ansible appserver -i ./inventory -m ping
```
Выполнение команд стороне хоста, указывается только идентификатор хоста, остальные данные берутся из ansible.cfg
```
ansible dbserver -m command -a uptime
```
Проверка хостов во всех группах, указанных в yaml файле
```
ansible all -m ping -i inventory.yml
```
Запуск команд на хостах, в группе app, через shell
```
ansible app -m shell -a 'ruby -v; bundler -v'
```

---

### Домашнее задание 11
#### Настройки
Необходимо прописать IP адреса инстансов к соответствующим группам, в файле ansible/hosts/inventory
Прописать внутренний IP адрес инстанса reddit-db для переменной db_host в основном файле сценария
#### Один плейбук c одним сценарием в reddit_app
Запуск сценария выполняется по отдельности для каждого тега, в данном случае:
```
ansible-playbook reddit_app_one_play.yml --check --limit db --tags db-tag
ansible-playbook reddit_app_one_play.yml --check --limit app --tags app-tag
ansible-playbook reddit_app_one_play.yml --check --limit app --tags deploy-tag
```
#### Один плейбук с несколькими сценариями в reddit_app
Позволяет запускать сценарий без указания параметра "--limit", с указанием в качесте файла сценария 
reddit_app_multiple_plays.yml, как в примере выше - последовательно, так и одной командой:
```
ansible-playbook reddit_app_multiple_plays.yml
```
### Несколько плейбуков
Каждый сценарий можно разместить в отдельном файле и подключить как библиотеку в головном, применив 
команду *import_playbook*<br/>
Получились файлы:
```
db.yml - настройки инстанса reddit-db
app.yml - настройки инстанса reddit-app
deploy.yml - установка и запуск сервиса puma
site.yml - головной файл для запуска сценариев
```
Запуск выполняется командой:
```
ansible-playbook site.yml
```
#### Замена скриптов в packer на сценарии ansible
Файлы с плейбуками разместил в папке packer/ansible/<br/>
Для истории, старые файлы app.json и db.json переименовал в app_old.json и db_old.json, соответственно.<br/>

Помимо указанных в ДЗ ссылок, пользовался еще данными по ссылке http://docs.w3cub.com/ansible/

---

### Домашнее задание 12
#### Некоторые команды для управления ролями:
Получение справки:
```
ansible-galaxy -h
```
формирование собственной роли (формируется структура):
```
ansible-galaxy init app
ansible-galaxy init db
```
загрузка коммьюнити роли jdauphant.nginx, согласно описания в файле requirements.yml
```
ansible-galaxy install -r environments/stage/requirements.yml
```
#### Общее описание по конфигурированию роли:
Формируется структура из каталогов и файлов. Данные из сценария переносятся в файлы main.yml, из
соответствующих секциям, папки. Папки template и files, из основной папки ansible, переносятся в 
папки с ролями, в зависимости какой роли, какой файл требуется. Все используемые переменные 
описываются в main.yml файле, каталога defaults, со значениями по умолчанию. Необходимые значения 
определяются в каталоге environments/[окружение]/group_vars, где окружение prod и stage в нашем
случае). Переменные определяются в файлаз с именем, таким же как и плейбук, при использовании
переменной во всех плейбуках, имя файла будет all. В эти же каталоги копируем inventory файл. 
Само окружение, с которым будем работать определяется в конфигурационном файле ansible.cfg, 
ссылаясь на inventory файл. Вызов ролей производится в плейбуке.
#### Использование коммьюнити ролей
В папку с конфигурированием окружения поместил файл, в котором указал название необходимой 
коммьюнити роли и ее версии. С помощью команды, что указал выше, загрузил данную роль, название 
папки добавил в исключение gitignore. Настройки для nginx прописал в файле для определения переменных 
stage/group_vars/app и так же для prod.
#### Открытие http порта (80)
Для открытия 80 порта, добавил в настройки модуля app, параметр "http_server".